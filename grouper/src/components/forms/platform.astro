---
const { platform = {} } = Astro.props;
const isEditing = Object.keys(platform).length > 0;
---

<form
    id="platformForm"
    class="max-w-2xl mx-auto bg-crust p-6 rounded-lg shadow-md"
>
    <div class="mb-4">
        <label for="slug" class="block text-sm font-medium text-text mb-1"
            >Slug</label
        >
        <input
            type="text"
            id="slug"
            name="slug"
            value={platform.slug || ""}
            required
            readonly={isEditing}
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue focus:border-indigo-500"
        />
    </div>

    <div class="mb-4">
        <label for="name" class="block text-sm font-medium text-text mb-1"
            >Name</label
        >
        <input
            type="text"
            id="name"
            name="name"
            value={platform.name || ""}
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue focus:border-indigo-500"
        />
    </div>

    <div class="mb-4">
        <label
            for="description"
            class="block text-sm font-medium text-text mb-1">Description</label
        >
        <textarea
            id="description"
            name="description"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue focus:border-indigo-500"
            >{platform.description || ""}</textarea
        >
    </div>

    <div class="mb-4">
        <label
            for="long_description"
            class="block text-sm font-medium text-text mb-1"
            >Long Description</label
        >
        <textarea
            id="long_description"
            name="long_description"
            rows="5"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue focus:border-indigo-500"
            >{platform.long_description || ""}</textarea
        >
    </div>

    <div class="mb-4">
        <label for="icon_url" class="block text-sm font-medium text-text mb-1"
            >Icon URL</label
        >
        <input
            type="url"
            id="icon_url"
            name="icon_url"
            value={platform.icon_url || ""}
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue focus:border-indigo-500"
        />
    </div>

    <div class="mb-4">
        <label for="site_url" class="block text-sm font-medium text-text mb-1"
            >Site URL</label
        >
        <input
            type="url"
            id="site_url"
            name="site_url"
            value={platform.site_url || ""}
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue focus:border-indigo-500"
        />
    </div>

    <div class="mb-4">
        <label
            for="wikipedia_url"
            class="block text-sm font-medium text-text mb-1"
            >Wikipedia URL</label
        >
        <input
            type="url"
            id="wikipedia_url"
            name="wikipedia_url"
            value={platform.wikipedia_url || ""}
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue focus:border-indigo-500"
        />
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="mb-4">
            <label
                for="color_primary"
                class="block text-sm font-medium text-text mb-1"
                >Primary Color</label
            >
            <input
                type="text"
                id="color_primary"
                name="color_primary"
                value={platform.color_primary || ""}
                placeholder="#RRGGBB"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue focus:border-indigo-500"
            />
        </div>

        <div class="mb-4">
            <label
                for="color_accent"
                class="block text-sm font-medium text-text mb-1"
                >Accent Color</label
            >
            <input
                type="text"
                id="color_accent"
                name="color_accent"
                value={platform.color_accent || ""}
                placeholder="#RRGGBB"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue focus:border-indigo-500"
            />
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="mb-4">
            <label
                for="total_markets"
                class="block text-sm font-medium text-text mb-1"
                >Total Markets</label
            >
            <input
                type="number"
                id="total_markets"
                name="total_markets"
                value={platform.total_markets || ""}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue focus:border-indigo-500"
            />
        </div>

        <div class="mb-4">
            <label
                for="total_traders"
                class="block text-sm font-medium text-text mb-1"
                >Total Traders</label
            >
            <input
                type="number"
                id="total_traders"
                name="total_traders"
                value={platform.total_traders || ""}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue focus:border-indigo-500"
            />
        </div>

        <div class="mb-4">
            <label
                for="total_volume"
                class="block text-sm font-medium text-text mb-1"
                >Total Volume</label
            >
            <input
                type="number"
                id="total_volume"
                name="total_volume"
                step="0.01"
                value={platform.total_volume || ""}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue focus:border-indigo-500"
            />
        </div>
    </div>

    <div
        id="errorMessage"
        class="hidden max-w-full mx-auto mb-4 p-4 bg-red/20 border border-red text-red rounded-lg"
    >
        <p class="font-medium">Error:</p>
        <p id="errorMessageText"></p>
    </div>

    <div class="flex justify-end space-x-4 mt-6">
        <a
            href="/platforms"
            class="px-4 py-2 bg-blue/50 text-text rounded-md hover:bg-blue transition-colors"
        >
            Cancel
        </a>
        <button
            type="submit"
            id="submitBtn"
            class="px-4 py-2 bg-green/50 text-white rounded-md hover:bg-green transition-colors"
        >
            {isEditing ? "Update" : "Create"} Platform
        </button>
    </div>
</form>

<script>
    import { createPlatform } from "@lib/api";

    const form = document.getElementById("platformForm");
    const errorDiv = document.getElementById("errorMessage");
    const errorText = document.getElementById("errorMessageText");
    const submitBtn = document.getElementById("submitBtn");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerText = "Saving...";
        errorDiv.classList.add("hidden");

        try {
            // Get form data
            const formData = new FormData(form);
            const platformData = Object.fromEntries(formData.entries());

            // Convert empty strings to null
            Object.keys(platformData).forEach((key) => {
                if (platformData[key] === "") {
                    platformData[key] = null;
                }
            });

            // Create platform
            await createPlatform(platformData);

            // Redirect on success
            window.location.href = "/platforms";
        } catch (error) {
            // Show error
            errorText.textContent =
                error.message ||
                "An unknown error occurred while creating the platform";
            errorDiv.classList.remove("hidden");

            // Reset button
            submitBtn.disabled = false;
            submitBtn.innerText = "Create Platform";

            // Scroll to error
            errorDiv.scrollIntoView({ behavior: "smooth" });
        }
    });
</script>
