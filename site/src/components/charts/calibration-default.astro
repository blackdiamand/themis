---
import type { MarketDetails, PlatformDetails } from "@types";
import type { CalibrationPoint } from "@lib/charts/types";
import { calculateCalibrationPoints } from "@lib/calibration";

import * as Plot from "@observablehq/plot";
import { JSDOM } from "jsdom";
const { document } = new JSDOM().window;

interface Props {
  platforms: PlatformDetails[];
  markets: MarketDetails[];
  width?: number;
  aspectRatio?: number;
  caption?: string;
}
let { platforms, markets, width, aspectRatio, caption } = Astro.props;

// Calculate calibration points
const points = await calculateCalibrationPoints(markets, "midpoint", null);

// Set default sizes
if (!width) width = 600;
let pointSizeRange = [width / 100, (width / 100) * 1.5];

// Generate the plot
const plot = Plot.plot({
  title: "Calibration Plot",
  width: width,
  aspectRatio: aspectRatio,
  x: {
    domain: [0, 100],
    percent: true,
    label: "Prediction (Midpoint)",
  },
  y: { domain: [0, 100], grid: true, percent: true, label: "Resolution" },
  r: { range: pointSizeRange, label: "Scale" },
  color: {
    legend: platforms.length > 1,
    label: "Platform",
    domain: platforms.map((p) => p.name),
    range: platforms.map((p) => p.color_primary),
  },
  marks: [
    Plot.dot(points, {
      x: "x_center",
      y: "y_center",
      r: "count",
      fill: "platform_slug",
      stroke: "platform_slug",
      fillOpacity: 0.5,
    }),
    Plot.line(points, {
      x: "x_center",
      y: "y_center",
      stroke: "platform_slug",
      strokeOpacity: 0.5,
    }),
    Plot.ruleX([0]),
    Plot.ruleY([0]),
    Plot.lineY(
      [
        { x: 0, y: 0 },
        { x: 1, y: 1 },
      ],
      { x: "x", y: "y" },
    ),
  ],
  document,
}).outerHTML;
---

<div
  class="bg-base-light [&_h2]:text-2xl [&_figcaption]:text-xs text-crust rounded-md drop-shadow-sm p-4 overflow-x-auto"
>
  <Fragment set:html={plot} />
  <p class="text-xs">
    {caption}
  </p>
  <p class="text-xs">
    Source: <a href="https://predictionmetrics.org">predictionmetrics.org</a>
  </p>
</div>
