---
import Base from "@layouts/base.astro";
import QuestionProbChart from "@components/question-prob-chart.astro";
import Traders from "@atoms/traders.astro";
import Volume from "@atoms/volume.astro";
import Duration from "@atoms/duration.astro";
import Grade from "@atoms/grade.astro";
import ScoreRel from "@atoms/score-rel.astro";
import ScoreAbs from "@atoms/score-abs.astro";
import LinkOut from "@icons/link-out.svg";
import {
  getMarketsByQuestion,
  getQuestions,
  getMarketScoresByQuestion,
  getQuestionOverallScores,
  getDailyProbabilities,
} from "@lib/api";

// Default score types
let absoluteScoreType = "brier-average";
let relativeScoreType = "brier-relative";

// Generate routes for all items
export async function getStaticPaths() {
  const questions = await getQuestions();
  return questions.map((question) => {
    return {
      params: { slug: question.slug },
      props: { question },
    };
  });
}
const { question } = Astro.props;

// Download question scores
const questionScores = await getQuestionOverallScores(question.id);

// Download market and scores
const markets = await getMarketsByQuestion(question.id);
const marketScores = await getMarketScoresByQuestion([question.id], null);

// Download daily probabilities
const dailyProbabilityPoints = await getDailyProbabilities(
  question.id,
  question.start_date_override,
  question.end_date_override,
);

// Select appropriate question scores
const absoluteQuestionScore = questionScores.find(
  (s) => s.score_type === absoluteScoreType,
);
if (!absoluteQuestionScore) {
  throw new Error(
    `No absolute question score found for question ${question.id} (${question.slug})`,
  );
}
const relativeQuestionScore = questionScores.find(
  (s) => s.score_type === relativeScoreType,
);
if (!relativeQuestionScore) {
  throw new Error(
    `No relative question score found for question ${question.id} (${question.slug})`,
  );
}
let questionWithScores = {
  question: question,
  absoluteScore: absoluteQuestionScore,
  relativeScore: relativeQuestionScore,
};

// Select appropriate market scores
let marketsWithScores = markets.map((market) => {
  const absoluteScore = marketScores.find(
    (s) => s.market_id === market.id && s.score_type == absoluteScoreType,
  );
  const relativeScore = marketScores.find(
    (s) => s.market_id === market.id && s.score_type == relativeScoreType,
  );
  if (!absoluteScore || !relativeScore) {
    throw new Error(
      `Missing scores for market ${market.id} (${market.platform_name}): ` +
        `absoluteScore=${!!absoluteScore}, relativeScore=${!!relativeScore}`,
    );
  }
  return {
    market: market,
    absoluteScore: absoluteScore,
    relativeScore: relativeScore,
  };
});
---

<Base title="Market">
  <div class="grid grid-cols-1 md:grid-cols-2 pt-4">
    <div class="p-4 m-2">
      <div class="text-2xl">{question.title}</div>
      <ul class="flex items-center space-x-4 my-2">
        <li class="font-semibold">Category:</li>
        <li>
          <a href={`/category/${question.category_slug}`} class="text-lavender">
            {question.category_name}
          </a>
        </li>
      </ul>
      <!-- TODO: Tags
        <ul class="flex items-center space-x-4 my-2">
            <li class="font-semibold">Tags:</li>
            {question.tags.map((tag) => <li>{tag}</li>)}
        </ul>
      -->
      <div class="whitespace-pre-wrap my-2">{question.description}</div>
    </div>
    <div>
      <QuestionProbChart points={dailyProbabilityPoints} />
    </div>
  </div>

  <!-- Platform Table -->
  <div class="pt-6 overflow-x-auto md:overflow-x-hidden">
    <table class="table-auto text-left p-4 m-2 w-full">
      <thead>
        <tr class="border-b-2">
          <th class="px-4 py-2 w-40">Platform</th>
          <th class="px-4 py-2">Link</th>
          <th class="px-4 py-2">Traders</th>
          <th class="px-4 py-2">Volume (USD)</th>
          <th class="px-4 py-2">Duration</th>
          <th class="px-4 py-2 text-center">Letter Grade</th>
          <th class="px-4 py-2 text-right">Relative Score</th>
          <th class="px-4 py-2 text-right">Absolute Score</th>
        </tr>
      </thead>
      <tbody>
        {
          marketsWithScores.map((item) => (
            <tr>
              <td class="px-4 py-2">{item.market.platform_name}</td>
              <td class="px-6 py-2">
                <a href={item.market.url}>
                  <LinkOut height={18} fill="currentColor" class="inline" />
                </a>
              </td>
              <td class="px-4 py-2">
                <Traders num={item.market.traders_count} />
              </td>
              <td class="px-4 py-2">
                <Volume num={item.market.volume_usd} />
              </td>
              <td class="px-4 py-2">
                <Duration num={item.market.duration_days} />
              </td>
              <td class="px-4 py-2 text-center">
                <Grade grade={item.relativeScore.grade} />
              </td>
              <td class="px-4 py-2 text-right">
                <ScoreRel num={item.relativeScore.score} />
              </td>
              <td class="px-4 py-2 text-right">
                <ScoreAbs num={item.absoluteScore.score} />
              </td>
            </tr>
          ))
        }
        <tr class="border-t-2">
          <td class="px-4 py-2">Overall</td>
          <td class="px-6 py-2"></td>
          <td class="px-4 py-2">
            <Traders num={question.total_traders} />
          </td>
          <td class="px-4 py-2">
            <Volume num={question.total_volume} />
          </td>
          <td class="px-4 py-2"> </td>
          <td class="px-4 py-2 text-center">
            <Grade grade={questionWithScores.absoluteScore.grade} />
          </td>
          <td class="px-4 py-2 text-right">
            <ScoreRel num={questionWithScores.relativeScore.score} />
          </td>
          <td class="px-4 py-2 text-right">
            <ScoreAbs num={questionWithScores.absoluteScore.score} />
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</Base>
